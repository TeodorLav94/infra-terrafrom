---
- name: ðŸš€ Setup Jenkins Server (CI/CD environment)
  hosts: jenkins_servers
  become: true 

  tasks:
    - name: Update apt cache and install Java 17 (needed for Jenkins/Maven)
      apt:
        name: 
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - software-properties-common
          - openjdk-17-jdk 
        state: present
        update_cache: yes

    - name: Install build tools (Maven and Git)
      apt:
        name: 
          - maven 
          - git
        state: present

    - name: Ensure /var/lib/jenkins directory exists
      file:
        path: /var/lib/jenkins
        state: directory
        mode: '0755'

    - name: Create filesystem on Jenkins data disk if needed
      filesystem:
        fstype: ext4
        dev: /dev/disk/by-id/google-persistent-disk-1

    - name: Mount Jenkins data disk on /var/lib/jenkins and persist in fstab
      mount:
        path: /var/lib/jenkins
        src: /dev/disk/by-id/google-persistent-disk-1
        fstype: ext4
        opts: defaults
        state: mounted

    - name: Ensure Jenkins owns /var/lib/jenkins
      file:
        path: /var/lib/jenkins
        owner: jenkins
        group: jenkins
        recurse: yes

    - name: Add HashiCorp GPG key
      ansible.builtin.get_url:
        url: https://apt.releases.hashicorp.com/gpg
        dest: /usr/share/keyrings/hashicorp-archive-keyring.asc
        mode: '0644'

    - name: Add HashiCorp APT repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/hashicorp-archive-keyring.asc] https://apt.releases.hashicorp.com bookworm main"
        state: present
        filename: hashicorp

    - name: Install Terraform
      apt:
        name: terraform
        state: present
        update_cache: yes

    - name: Install Ansible (for running infra playbooks from Jenkins)
      apt:
        name: ansible
        state: present
        update_cache: yes

    - name: Add Docker GPG apt Key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'

    - name: Add Docker Repository
      ansible.builtin.apt_repository:
        repo: deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian bookworm stable
        state: present

    - name: Install Docker (using official Ansible module)
      apt:
        name: 
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: Install Python 3 and pip
      apt:
        name:
          - python3
          - python3-pip
        state: present
        update_cache: yes

    - name: Install semver library for Python
      pip:
        name: semver
        executable: pip3
        extra_args: "--break-system-packages"

    - name: Get Jenkins GPG key
      ansible.builtin.get_url:
        url: https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
        dest: /usr/share/keyrings/jenkins-keyring.asc
        mode: '0644'

    - name: Add Jenkins repository
      ansible.builtin.apt_repository:
        repo: deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/
        state: present
        filename: jenkins

    - name: Install Jenkins
      apt:
        name: jenkins
        state: present
      notify: Restart Jenkins

    - name: Enable Jenkins service
      service:
        name: jenkins
        enabled: yes

    - name: Add Jenkins user to docker group
      user:
        name: jenkins
        groups: docker
        append: yes

  handlers:
    - name: Restart Jenkins
      service:
        name: jenkins
        state: restarted